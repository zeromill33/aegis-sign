# Status
Done

# Story
**As a** 网关/调用方
**I want** 使用统一且稳定的 `create`/`sign` 接口
**so that** 能以最小载荷调用签名并便于后续优化/观测。

# Acceptance Criteria
1. 已部署网关与 Enclave，`POST /create` 返回 `{keyId, publicKey, address?}`，响应 ≤ 5ms（不含后台持久化）
2. `POST /sign` 仅接受 `digest(32B)`，非 32B 直接 400/INVALID_ARGUMENT
3. 统一错误码集合：`UNLOCK_REQUIRED`、`RETRY_LATER`、`INVALID_KEY`（文档化并对齐网关）
4. 存在 Proto/OpenAPI 合约与生成的 Go stub，并纳入 CI

# Tasks / Subtasks
- [x] 定义/更新 API 合约并生成 Go stub（AC: 1,4）
  - [x] 在 `docs/api/openapi.yaml` 中补齐 `POST /create`/`POST /sign` schema，明确 `{keyId, publicKey, address?}` 响应字段、`digest(32B)` 约束与错误集合
  - [x] 在 `docs/api/proto/signer.proto` 中同步字段/枚举，并声明错误码枚举与 gRPC status map
  - [x] 运行 `buf generate`（或 `protoc`）输出 Go stub 至 `docs/api/gen/go/signer`（新建）并接至仓库 CI（失败即阻断）
- [x] 输入校验与统一错误码实现（AC: 2,3）
  - [x] 在 signer 服务入口（HTTP 及 gRPC handler）对 `digest` 长度与编码做校验，非法直接返回 400/INVALID_ARGUMENT
  - [x] 维护一份 HTTP/gRPC↔业务错误码映射表（Markdown + 代码常量），并在 handler 中统一引用
- [x] `/create` 响应与 SLA 验收（AC: 1）
  - [x] 生成 deterministic `keyId/publicKey/address?` 样例（存入 `docs/api/examples/create.json`）并在 handler 返回，记录 ≤5 ms 预算
  - [x] 将 `/create` handler 的关键路径指标（`http_grpc_requests_total`,`sign_latency_ms{phase}`）接入现有指标注册
- [x] 文档 & 示例（AC: 1,3,4）
  - [x] 更新 `docs/api/README.md`，加入 curl/grpcurl 示例、错误码语义、Retry-After 说明
  - [x] 记录 request-id/tenant-id 预留字段及默认禁用理由，并描述观测指标
- [x] 测试/CI（AC: 1,2,3,4）
  - [x] 单元测试覆盖 32B 校验、错误码映射
  - [x] 集成测试验证 `/create`、`/sign` 正常路径与 OpenAPI/Proto schema 对齐
  - [x] 新增 CI 步骤：验证 proto/openapi 生成文件 up-to-date、stub 代码 gofmt/go test 通过；`/create` latency 基准脚本确认 ≤5 ms（不含持久化）

# Dev Notes
- 来源：docs/bmad-stories-create-sign.md S1（docs/bmad-stories-create-sign.md:25-40）。
- 现有 API 参考：`docs/api/openapi.yaml`、`docs/api/proto/signer.proto`、`docs/api/README.md`。
- `/create` 响应需包含 `{keyId, publicKey, address?}` 并满足 5 ms SLA（不含后台持久化）。
- `/sign` 只能接受 32B `digest`，传输上支持 `hex`（默认）或 `base64`，错误立刻映射为 HTTP 400 / gRPC INVALID_ARGUMENT。
- 错误码语义（统一在共享错误模块中定义）：
  - `UNLOCK_REQUIRED`：后台解锁流程触发，调用方退避重试（HTTP 503 + Retry-After / gRPC UNAVAILABLE）。
  - `RETRY_LATER`：系统限流/瞬时错误，调用方 50–200 ms 抖动退避（HTTP 429 / gRPC RESOURCE_EXHAUSTED）。
  - `INVALID_KEY`：`keyId` 不存在/状态不允许（HTTP 404 或 409，按网关约定）。
- 观测指标（Epic S1）：接入 `http_grpc_requests_total`、4xx/5xx 分布、`sign_latency_ms{phase}`。指标命名遵循 `docs/api/README.md`。
- 安全字段：`x-request-id`、`x-tenant-id` 需在 OpenAPI/Proto 中预留但默认禁用，仅审计场景打开。
- Go stub 生成后需纳入 CI，确保 `buf generate`、`go test ./docs/api/gen/go/...` 通过。

## Testing
- 单元：Go + testing/testify，覆盖 `digest` 长度/编码校验、错误码→HTTP/gRPC 映射、`UNLOCK_REQUIRED`/`RETRY_LATER` retry header。
- 合约：对 `docs/api/openapi.yaml`/`docs/api/proto/signer.proto` 运行 schema 校验，并确保生成的 Go stub 与源一致（CI 中 `buf lint` / `buf generate --diff`）。
- 集成：启动 signer/gateway handler，调用 `/create` `/sign` happy path，验证响应字段与错误集合；记录 `/create` handler 5 ms SLA 统计（工具：ghz/vegeta）。
- 观测：验证 `http_grpc_requests_total`、`sign_latency_ms{phase}` 指标及 request-id/tenant-id 头部预留行为。

# Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-19 | v1 | 初始创建 | PM |
| 2025-11-20 | v2 | 补齐 INVALID_KEY、HTTP/gRPC handler 与 API CI 修复 | Dev |

# Dev Agent Record

## Agent Model Used
OpenAI GPT-5 (Codex)

## Debug Log References
- `make api-ci`

## Completion Notes List
- 完成 OpenAPI/Proto 扩展、Go stub 与观测样例
- 新增 validator/apierrors 包与观测规范，约束 32B 校验和错误码映射
- 提供 `Makefile` + `go test` 流程校验 schema/validator/apierrors
- 补齐 `INVALID_KEY` 错误码并同步 OpenAPI/Proto/README/示例及业务常量
- 新增 `internal/api` HTTP/gRPC handler + Buf 生成/`make api-ci` 流程，接入 digest 校验与 5ms SLA 测试

## File List
- Makefile
- buf.gen.yaml
- buf.work.yaml
- go.mod
- go.sum
- docs/api/proto/buf.yaml
- docs/api/openapi.yaml
- docs/api/README.md
- docs/api/observability.md
- docs/api/examples/create.json
- docs/api/proto/signer.proto
- docs/api/gen/go/signer.pb.go
- docs/api/gen/go/signer_grpc.pb.go
- docs/api/tests/proto_test.go
- docs/api/tests/schema_test.go
- pkg/apierrors/apierrors.go
- pkg/apierrors/apierrors_test.go
- pkg/validator/digest.go
- pkg/validator/digest_test.go
- internal/api/backend.go
- internal/api/http.go
- internal/api/http_test.go
- internal/api/grpc.go
- internal/api/grpc_test.go
# QA Results
- 2025-11-20 Quinn (QA) —— Gate: FAIL
  - [高] 接口规范与实现均缺少 `INVALID_KEY` 错误码及 HTTP/gRPC 映射，违反 AC3。
  - [高] 没有任何 HTTP/gRPC handler 实际引用 `pkg/validator` 与 `pkg/apierrors`，无法在入口强制 32B 校验与统一错误码。
  - [中] 示例 `docs/api/examples/create.json` 包含 schema 未定义的 `sla` 字段，与 OpenAPI 定义不符。
  - [中] 缺少确保 `buf generate`/stub 对齐与 `/create` SLA 的 CI 步骤，仅有 `go test` 目标。
  - [测试] `GO=/opt/homebrew/bin/go go test ./...` ✅（需纳入正式 CI）。
- 2025-11-20 Quinn (QA) —— Gate: PASS
  - [覆盖] OpenAPI/Proto/README 现已记录 `INVALID_KEY`（404/409/gRPC NotFound），示例亦回到 `{keyId, publicKey, address?}`（docs/api/openapi.yaml:5-188，docs/api/proto/signer.proto:1-60，docs/api/README.md:10-15，docs/api/examples/create.json:1-4）。
  - [实现] 新增 `internal/api` HTTP/gRPC handler 接入 `validator` 与 `apierrors`，确保 `/sign` 仅接受 32B digest，错误统一映射；`make api-ci` 串联 Buf lint/generate、stub 差异校验、SLA/单测回归（internal/api/http.go:1-200，internal/api/grpc.go:1-63，Makefile:1-23）。
  - [测试] `make api-ci` ✅（含 `buf lint`、`buf generate --template buf.gen.yaml`、`go test ./internal/api -run TestCreateFastPathBudget`、`go test ./pkg/... ./docs/api/tests`）。
