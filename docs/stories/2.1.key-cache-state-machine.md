# Status
Review

# Story
**As a** 签名服务后端工程师
**I want** 实现 WARM/COOL/INVALID 状态机与 TTL/Uses 语义
**so that** PlainKey 过期/用尽不触发 KMS，DEK 有效时本地再水合，稳定热路径。

# Acceptance Criteria
1. WARM：直接签名；COOL：本地再水合成功率 > 99.5%；INVALID：热路径不等待 KMS
2. `hard_expired_rejections_total ≈ 0`（演练除外）
3. Entry 结构包含：`Priv32, UsesLeft, SoftTTL, HardTTL, DEK.ValidUntil`
4. 到期清零与原子状态切换正确；密文 Blob 在 Enclave 保持只读副本
5. 指标：`key_cache_state{WARM|COOL|INVALID}`

# Tasks / Subtasks
- [x] KeyEntry 结构与状态机实现（AC: 1,3,4）
  - [x] 在 `internal/app/backend/keycache` 定义 `Entry` 结构：`Priv32 [32]byte`、`UsesLeft uint32`、`SoftTTL time.Time`、`HardTTL time.Time`、`DEKValidUntil time.Time`、`CipherBlob []byte`（仅加密副本）。提供 `State()`/`Transition()` 等原子操作，支持多线程热路径（参考 docs/bmad-create-sign-nitro-enclaves.md:54-75）。
  - [x] 实现 `State` 枚举（`WARM`,`COOL`,`INVALID`），并以 `sync.Mutex` 与安全擦除方法保护 `Priv32` 更新，确保 Soft/Hard TTL、Uses 剩余与 state 切换一致。
- [x] TTL/Uses 驱动器与再水合入口（AC: 1,2,4）
  - [x] Soft TTL 或 `UsesLeft < lowWaterMark`（50_000）时，保持 WARM 签名但将条目标记为 STALE 并通过 notifier 触发 single-flight 刷新；Hard TTL 或 `UsesLeft == 0` 触发限时同步刷新（<=3–5ms），失败则置 `INVALID` 并返回 `UNLOCK_REQUIRED`（docs/bmad-create-sign-nitro-enclaves.md:66-89、docs/bmad-stories-create-sign.md:72-79）。
  - [x] `rehydrate(keyId)` 在本地使用 DEK 解密 `CipherBlob` → 恢复 `Priv32` → 重置 TTL/Uses，并记录刷新耗时 + 成功率供 AC2、AC3 验证。
- [x] 只读密文副本与安全擦除（AC: 3,4）
  - [x] 父机提供的密文 Blob 需存储于 Enclave 内 `CipherBlob`（`[]byte` 只读映射），写入统一 `cipherpool` 并在 PlainKey 擦除时保持副本不变，确保可重复再水合；PlainKey 清零使用 `crypto/subtle` 辅助防止优化（docs/bmad-create-sign-nitro-enclaves.md:58-64）。
  - [x] 在切换到 `COOL` 或 `INVALID` 前，强制 `Priv32` buffer 填零，并将 `UsesLeft` 置 0，防止幻读；写操作受互斥锁保护。
- [x] 指标与日志（AC: 2,5）
  - [x] 在 `internal/app/backend/keycache/metrics.go` 注入 Prometheus 指标：`key_cache_state{state="WARM|COOL|INVALID", enclave}` Gauge、`hard_expired_rejections_total{keyspace}` Counter、`rehydrate_latency_ms` Histogram、`rehydrate_fail_total` Counter；将命名与 docs/bmad-create-sign-nitro-enclaves.md:117-123 及 Acceptance Criteria 5 对齐。
  - [x] 记录结构化日志：软/硬过期、grace ops、cipher 再水合失败、`UNLOCK_REQUIRED` 返回；日志字段包含 `keyId`, `state`, `ttl`, `usesLeft`。
- [x] 测试与验证（AC: 1,2,4）
  - [x] 单元测试 `./internal/app/backend/keycache`: 覆盖 WARM→COOL→INVALID 状态迁移、Soft/Hard TTL/Uses 触发、原子切换与 PlainKey 擦除。
  - [x] 基准/集成：构造 50k key 条目，模拟 TTL/Uses 消耗，验证 `hard_expired_rejections_total ≈ 0`（只在强制注入失败时增加）；压测中统计 `COOL` 期间本地再水合成功率 ≥99.5%，并确保热路径不阻塞 KMS。
  - [x] 观测验证：通过 `prometheus.Registry` 注册指标并使用 fake clock 检查 `key_cache_state` 更新频率、`rehydrate_latency_ms` 直方图 bucket。

# Dev Notes
- 设计来源：Epic E2 S3（docs/bmad-stories-create-sign.md:57-80）与《Nitro Enclave create/sign 路径》（docs/bmad-create-sign-nitro-enclaves.md:54-90）。务必遵循文档给出的 TTL、Uses 与状态定义，避免出现未授权的状态或字段。
- KeyEntry 结构：PlainKey（32B）、DEK（内存副本）、只读密文 `CipherBlob`、`SoftTTL=15m`、`HardTTL=16m`、`DEK.ValidUntil=60m`、`maxUses=1_000_000`、`low_water_mark=50_000`（docs/bmad-create-sign-nitro-enclaves.md:57-74）。`Priv32` 必须存放在 enclave 内受控内存，任何进入 COOL/INVALID 的路径都要 `zero` 掉明文。
- 状态语义：
  - `WARM` —— PlainKey/DEK 同时有效 → 直接签名；`State=WARM` 时 `key_cache_state{state="WARM"}` 增加 1（docs/bmad-create-sign-nitro-enclaves.md:62-65）。
  - `COOL` —— PlainKey 已被擦除、DEK 仍有效 → 本地 `rehydrate` 毫秒内恢复。COOL 期间请求仍允许签名，但要异步触发 single-flight 刷新（与 Story 2.2 接口对齐）并记录 `rehydrate_latency_ms` 指标。
  - `INVALID` —— DEK 同时过期或刷新失败 → 上层需立刻返回 `UNLOCK_REQUIRED` 并交由 Story 2.3 的异步解锁路径执行（docs/bmad-create-sign-nitro-enclaves.md:63-69, 98-101）。
- Soft/Hard TTL 行为：达到 soft TTL 后允许签名但必须安排 single-flight 刷新；达到 hard TTL 时在 3–5ms `refresh_budget` 内同步刷新，超时视为失败并计数 `hard_expired_rejections_total`（docs/bmad-create-sign-nitro-enclaves.md:66-90）。`refreshWindow=2m`、`jitter=±10%` 由 Story 2.2 承担，但本故事要暴露 hook（channel/callback）供 single-flight 消费。
- 密文副本：Enclave 可维护 Cipher Blob 的只读副本，便于本地再水合，需确保副本来源受父机审计并在写入时打标签 `blob_revision` 供日志追踪（docs/bmad-create-sign-nitro-enclaves.md:58-60）。
- 接口与依赖：
  - key cache 模块将被 `internal/app/backend` 正式 backend 引用，并与 `internal/infra/enclaveclient`（连接池 + vsock）共享 `TargetID`/enclave label。
  - Story 2.2（single-flight）会消费本模块暴露的 `Refresh(keyID)`、`MarkStale()` API；Story 2.3 依赖本模块在 `INVALID` 时明确抛出 `apierrors.CodeUnlockRequired`。
- 观测：需要落地 `state_count{WARM|COOL|INVALID}`、`rehydrate_*`、`hard_expired_rejections_total`、`NEEDS_UNLOCK_total` 指标（docs/bmad-create-sign-nitro-enclaves.md:117-123），并按照 `docs/runbook` 中 SLO 监控要求输出日志。

## Testing
- 单元：`go test ./internal/app/backend/keycache -run TestStateTransitions`，使用 fake clock 与自增 Uses 模拟 Soft/Hard TTL、low water mark、原子切换、PlainKey 擦除。
- 集成：通过 `internal/app/backend` backend stub 注入 fake `CipherBlob` 与 mock KMS，验证 COOL→WARM 本地再水合成功率 ≥99.5%，hard 过期 3ms 内刷新成功率；失败路径需返回 `apierrors.CodeUnlockRequired`。
- 指标：注册 `prometheus.NewRegistry()`，对多 key 操作后断言 `key_cache_state`、`rehydrate_latency_ms`、`hard_expired_rejections_total` 与 AC2 保持一致；配合 `docs/runbook` 的告警阈值脚本验证 `hard_expired` 接近 0。
- 安全：fuzz `CipherBlob` 输入，确认所有失败路径都先清零 PlainKey 才返回错误；在 race detector 下运行以验证并发安全。

# Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-19 | v1 | 初始创建 | PM |
| 2025-11-20 | v2 | 补充状态机实现细节、Dev Notes、测试与模板缺失的章节 | PM |

# Dev Agent Record

## Agent Model Used
OpenAI GPT-5 (Codex)

## Debug Log References
- `go test ./internal/app/backend/keycache`

## Completion Notes List
- 新增 `internal/app/backend/keycache` 包，包含 Entry 状态机、时钟抽象、指标、再水合/通知接口与安全擦除实现，满足 AC1/3/4。
- 将 soft/hard TTL 与 Uses 驱动封装在 Checkout 流程中，支持本地同步再水合、背景刷新通知以及 `UNLOCK_REQUIRED` 错误路径，记录结构化日志。
- 注入 Prometheus 指标（state gauge、hard_expired counter、rehydrate latency/fail counter）并在测试中使用 fake clock 验证 TTL/指标行为。
- 补充 `entry_test.go` 覆盖 WARM→COOL→INVALID、软/硬 TTL、再水合失败与密文副本只读等场景，`go test` 通过。

## File List
- internal/app/backend/keycache/state.go
- internal/app/backend/keycache/clock.go
- internal/app/backend/keycache/metrics.go
- internal/app/backend/keycache/rehydrate.go
- internal/app/backend/keycache/errors.go
- internal/app/backend/keycache/entry.go
- internal/app/backend/keycache/entry_test.go
- docs/stories/2.1.key-cache-state-machine.md

# QA Results
- 2025-11-20 Quinn (QA) —— Gate: PASS (8.5/10, Confidence: Medium)
  - [高] 缺少与单航班/解锁流程的接口契约；Entry 仅暴露简单回调，需与 Story 2.2/2.3 对齐，避免后续集成阻塞。
  - [中] 未覆盖 >3ms refresh budget 超时的测试场景，建议补充以确保 `hard_expired_rejections_total` 与 INVALID 行为可验证。
  - [低] 新增指标未带 namespace/subsystem，建议下一版本统一 `signer_*` 命名以免冲突。
