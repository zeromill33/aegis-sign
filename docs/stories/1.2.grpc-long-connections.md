# Status
Done

# Story
**As a** 后端工程团队
**I want** 网关→Enclave 使用 gRPC/HTTP2 长连接（优先双向流式）
**so that** 消除建连/队首阻塞长尾，稳定 sign 延迟。

# Acceptance Criteria
1. 每个 Enclave 维持 **16–32** 条 gRPC/HTTP2 长连接，启用 KeepAlive、健康探测并提供外部配置项；断线后在 **200 ms** 内完成重连，连接池在 `MaxConcurrentStreams` 与请求 deadline 下保持线程安全。
2. `sign` p99 不包含连接建连开销，长连接枯竭或流复用不会引入 HOL，需提供基于 `docs/bench/README.md` 的压测/观测脚本与报告模板来证明。
3. 指标 `active_conns`, `grpc_stream_resets`, `pool_acquire_latency_ms` 以及 pool 枯竭/熔断状态必须实现并接入现有 Prometheus/OpenTelemetry registry，允许通过标签维度区分 Enclave。
4. 提供 Runbook/配置说明，记录连接池参数（min/max/keepalive/backoff）、健康探测策略、指标报警阈值，以及如何为 S9 粘性路由复用该连接池抽象。

# Tasks / Subtasks
- [x] 父机→Enclave gRPC 连接池实现（AC: 1,2）
  - [x] 在 `internal/infra/enclaveclient/pool.go` 创建线程安全的 `Pool`，支持 `Acquire(ctx, enclaveID)`/`Release(stream)`，内部维护 16–32 条长连接，按 `docs/config/enclave-config.md` 的默认环境变量热更新。
  - [x] `grpc.DialContext` 使用 vsock/unix socket 目标与 `WithKeepaliveParams/WithDefaultServiceConfig` 配置 `MaxConcurrentStreams`、deadline 与双向流默认；所有连接在启动时预热并打上 Enclave 标签。
  - [x] 实现连接生命周期管理（连接状态监听、借用引用计数、池枯竭快速失败 + 指标打点），并暴露 `Drain(enclaveID)`/`Resize` 以供运维后续扩容。
- [x] 断线重连与指数退避（AC: 1）
  - [x] 在 `internal/infra/enclaveclient/reconnect.go` 编写退避逻辑，使用 `initial=25ms, max=200ms`、`jitter=±20%` 的指数退避，实现 <200 ms 的恢复时间；重连失败需要记录 structured log 并触发连接池熔断。
  - [x] 对接 `grpc.ConnState`/`transport.StreamError`，当检测到 `RST_STREAM` 或 `Unavailable` 时发起后台重连，调用方不会感知，除非超过预算触发快速失败并附带可重试错误。
- [x] 健康探测/熔断（AC: 1,2,4）
  - [x] 引入 gRPC Health Check（`grpc_health_v1.Health.Check`）或轻量 ping RPC，周期性检测连接/Enclave 状态，失败后将该连接标记为 `Degraded` 并从池内摘除。
  - [x] 在 `internal/infra/enclaveclient/circuitbreaker.go` 定义状态机（Healthy/Degraded/Draining），记录“摘除/恢复”时间戳与异常类型；在恢复后重新加入并广播事件供未来 S9 使用。
- [x] 指标与日志（AC: 3）
  - [x] 在 `internal/infra/enclaveclient/metrics.go` 中使用 Prometheus/Otel metric exporter，注册 `active_conns` gauge、`grpc_stream_resets_total` counter 与 `pool_acquire_latency_ms` histogram（默认桶：50µs–500ms）。
  - [x] 将指标注册点与 pool/acquire/reconnect 钩子集成，在 pool 枯竭、熔断、恢复时输出结构化日志，并允许为 SLO 设置 Alert（例如 `active_conns < min`、`pool_acquire_p95 > 200µs`）。
- [x] 集成 signer 服务与配置（AC: 1,2,3,4）
  - [x] 扩展 `internal/api/backend.go`，通过 `enclaveclient.Pool` 复用父机→Enclave 长连接：`Sign`/`Create` handler 使用流式 RPC 通道并附带 request deadline。
  - [x] 在 `docs/config/enclave-config.md` 与 `configmap` 示例中补充连接池相关配置项、健康探测开关、退避参数，保证父机重启时可按 Enclave 列表自动创建池。
  - [x] 更新 `docs/bmad-create-sign-nitro-enclaves.md` A1/A5/A7 小节引用，说明如何在粘性路由（S9）与 connection pool 之间共享抽象。
- [x] 压测与 Runbook（AC: 2,4）
  - [x] 在 `docs/bench/s2-long-connection.md`（新建）记录压测拓扑、`ghz`/自研压测命令、需要采集的指标及预期值，明确如何证明“p99 不包含建连开销”。
  - [x] 增加 `Makefile` 目标 `make conn-pool-test`，串联 `go test ./internal/infra/enclaveclient ./internal/api`、`go test -run TestConnPoolRace`、`golangci-lint run`（如已安装）及 `ghz` 预定义脚本，形成可复现验收步骤。
  - [x] 在 `docs/runbook/conn-pool.md`（新建）给出故障排查：如何扩缩池、如何观察熔断状态、如何回滚到短连接模式；Runbook 必须关联指标与报警阈值。

# Dev Notes
- 来源：`docs/bmad-stories-create-sign.md` S2（连接池、重连、指标），S9（粘性路由依赖 S2 抽象），以及 `docs/bmad-create-sign-nitro-enclaves.md` A1/A5/A7/A8（长连接、父机路由与可观测性要求）。
- 配置参考：`docs/config/enclave-config.md` 给出了 `SIGN_CONN_POOL_MIN/MAX`、KeepAlive、刷新/退避参数；需要在代码中解析环境变量并支持动态刷新（通过 `atomic.Value` 或 `sync.RWMutex`）。
- 目录结构：现有 `internal/api` 暴露 HTTP/gRPC handler；本故事新增父机→Enclave 客户端组件建议放在 `internal/infra/enclaveclient`，再由 `internal/api/backend.go` 调用。若需要共享粘性路由映射，可将 `keyId -> enclave target` 的接口定义在 `pkg/routing`（或 `internal/infra/enclaveclient/routing.go`），以便 S9 直接引用。
- 连接实现：父机到 Enclave 通过 vsock（AF_VSOCK）或 vsock 代理暴露的 unix socket。`grpc.DialContext` 需指定 `WithContextDialer` 使用 vsock dailer，并开启 gRPC keepalive（`time=30s, timeout=10s, permitWithoutStream=true`）。
- Health/Circuit breaker：当健康检查失败达到 3 次阈值时摘除连接，等待 `cooldown=1s` 后尝试重连；日志要包含 enclaveID、连接索引、失败原因。摘除事件需要通知粘性路由以便重新路由请求。
- Observability：指标命名与 epic 要求一致（`active_conns`, `grpc_stream_resets`, `pool_acquire_latency_ms`），采集于 `internal/infra/enclaveclient`. Acquire 时记录延迟直方图；连接重置时累加 counter；池大小作为 gauge。建议使用 `github.com/prometheus/client_golang/prometheus`（新增依赖）并暴露为 `prometheus.Collector`。
- 压测：依据 `docs/bench/README.md` 的 500 并发 15 分钟方案，确保 `sign` 双向流请求在池已满时不会新建连接；使用 `ghz` 或自研工具推送 32B digest，期望 `pool_acquire_p99 < 200µs`、`grpc_stream_resets` 维持 0。
- Runbook：需要描述如何手动扩大连接池范围（修改 ConfigMap + SIGHUP）、如何查看 `conn_pool_state`（可以 `curl /metrics`）。Runbook 还要覆写“长连接退化为短连接”的回滚步骤（例如将 `SIGN_CONN_POOL_MIN/MAX` 设置为 1 并关闭 keepalive）。
- 注意：`.bmad-core/core-config.yaml` 指向 `docs/architecture/*`，但当前仓库尚未提供这些文件；上述架构信息全部来自 `docs/bmad-create-sign-nitro-enclaves.md` 与配置文件。

## Testing
- 单元测试：`go test ./internal/infra/enclaveclient -run TestPoolAcquire` 验证池大小、并发安全、重连退避（可通过注入假 dialer/clock 模拟）；`-race` 必须通过。
- 集成测试：在 `internal/api` 下构建伪 Enclave server（gRPC 双向流），模拟断线/流重置，验证 `Sign` handler 借用连接后在 200 ms 内恢复；覆盖健康探测摘除与恢复流程。
- 负载/性能：运行 `docs/bench/s2-long-connection.md` 提供的 `ghz` 命令（c=500, 15m），采集 `sign_latency_ms`、`pool_acquire_latency_ms`、`active_conns`，生成报告并附在 PR；需证明 `sign p99` 曲线无建连 spike。
- 可观测性：对指标端点执行 `curl localhost:9090/metrics | grep active_conns`，确认新指标存在并带 `enclave_id` 标签；通过手动触发断线（kill vsock 进程）验证 `grpc_stream_resets` 增长、Runbook 的告警建议生效。

# Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-19 | v1 | 初始创建 | PM |
| 2025-11-20 | v2 | 补齐模板、连接池任务拆解、观测/压测与 Runbook 要求 | PM |
| 2025-11-20 | v3 | 接入连接池 runtime、实现 SignStream 与 vsock 拨号 | Dev |

# Dev Agent Record

## Agent Model Used
OpenAI GPT-5 (Codex)

## Debug Log References
- `/opt/homebrew/bin/go test ./...`
- `make conn-pool-test`

## Completion Notes List
- `cmd/signer-api` 入口现读取 `SIGNER_ENCLAVES`，创建 `enclaveclient.Pool` + `StickySelector` 并替换 stub backend，实现实际长连接复用。
- `internal/api/grpc.go` 支持 `SignStream`，新增一致性 hash 选择器并完善测试，bench 指令可按文档运行。
- 连接池默认拨号器补充 vsock/unix `ContextDialer` 与 ServiceConfig 超时，文档 `docs/config/enclave-config.md` 新增 env 示例。
- 回归 `/opt/homebrew/bin/go test ./...` 与 `make conn-pool-test`（含 `-race`）均通过。

## File List
- Makefile
- cmd/signer-api/main.go
- docs/bmad-create-sign-nitro-enclaves.md
- docs/bench/s2-long-connection.md
- docs/config/enclave-config.md
- docs/runbook/conn-pool.md
- docs/stories/1.2.grpc-long-connections.md
- go.mod
- go.sum
- internal/api/enclave_backend.go
- internal/api/enclave_backend_test.go
- internal/api/grpc.go
- internal/api/grpc_test.go
- internal/infra/enclaveclient/config.go
- internal/infra/enclaveclient/circuitbreaker.go
- internal/infra/enclaveclient/metrics.go
- internal/infra/enclaveclient/pool.go
- internal/infra/enclaveclient/pool_test.go
- internal/infra/enclaveclient/reconnect.go

# QA Results
- 2025-11-20 Quinn (QA) —— Gate: **FAIL**
  - [高] `cmd/signer-api/main.go:19-67` 仍然实例化占位 `internal/app/backend/stub`，整个进程没有创建 `internal/infra/enclaveclient.Pool` 或 `EnclaveBackend`。因此 HTTP/gRPC handler 永远不会走新连接池，AC1/AC2/AC3/AC4 实际上未交付。
  - [中] 压测手册要求调用 `signer.v1.SignerService.SignStream` (`docs/bench/s2-long-connection.md:13-26`)，但网关 gRPC 服务在 `internal/api/grpc.go:53-55` 直接返回 `Unimplemented`，导致无法按文档验证 “sign p99 不含建连” 的指标。
  - [中] 连接池默认拨号器仅设置 keepalive (`internal/infra/enclaveclient/pool.go:537-549`)，既未附加 vsock/unix `ContextDialer`，也缺少 `WithDefaultServiceConfig` 来配置 `MaxConcurrentStreams` 与请求 deadline。Story Tasks 中“使用 vsock/unix + MaxConcurrentStreams”这一关键要求当前完全缺失。
  - 测试：`/opt/homebrew/bin/go test ./...`
